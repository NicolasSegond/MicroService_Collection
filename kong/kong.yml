_format_version: "3.0"
_transform: true

services:
  # --- User Service (protégé, bearer only) ---
  - name: user-service
    url: http://user-service:8000
    routes:
      - name: user-route
        paths: ["/api/users", "/api/users/"]
        strip_path: false
        plugins:
          - name: oidc
            config:
              discovery: "${KC_ISSUER}/.well-known/openid-configuration"
              client_id: "${KC_CLIENT_ID}"
              client_secret: "${KC_CLIENT_SECRET}"
              ssl_verify: "no"
              bearer_only: "yes"
              realm: "kong"
              scope: "openid profile email"
              userinfo_header_name: "X-Userinfo"
              access_token_header_name: "X-Access-Token"
              id_token_header_name: "X-Id-Token"

  # --- Article Service ---
  - name: article-service
    url: http://article-service:8000
    routes:
      # Ecriture protégée
      - name: article-protected
        paths: ["/api/articles", "/api/articles/"]
        methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
        strip_path: false
        plugins:
          - name: oidc
            config:
              discovery: "http://keycloak:8080/realms/collector_realms/.well-known/openid-configuration"
              client_id: "collector"
              client_secret: "IDH11sNeKIFpDUEcLavTzR0QzYuJpf1G"
              introspection_endpoint: "http://keycloak:8080/realms/collector_realms/protocol/openid-connect/token/introspect"
              introspection_endpoint_auth_method: "client_secret_post"
              ssl_verify: "no"
              bearer_only: "yes"
              realm: "kong"
              scope: "openid profile email"
              userinfo_header_name: "X-Userinfo"
              access_token_header_name: "X-Access-Token"
              id_token_header_name: "X-Id-Token"

      # --- Health endpoint (pour ZAP et monitoring) ---
  - name: health-service
    url: http://example.com # ne sera pas contacté grâce au plugin request-termination
    routes:
      - name: health-route
        paths: [ "/health" ]
        strip_path: true
        plugins:
          - name: request-termination
            config:
              status_code: 200
              message: '{"status":"ok"}'

# PLUGINS GLOBAUX
plugins:
  - name: cors
    config:
      origins: ["http://localhost:3000"]
      methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
      headers: ["Accept", "Content-Type", "Authorization"]
      exposed_headers: ["X-Request-ID"]
      credentials: true
      max_age: 3600

  - name: response-transformer
    config:
        remove:
          headers: [ "Server" ]
        add:
          headers:
            - "X-Content-Type-Options: nosniff"
            - "X-Frame-Options: DENY"
            - "X-XSS-Protection: 1; mode=block"
            - "Content-Security-Policy: default-src 'self'; frame-ancestors 'none'"
            - "Permissions-Policy: geolocation=(), microphone=(), camera=()"
            - "Cache-Control: no-store, no-cache, must-revalidate"
            - "Pragma: no-cache"

  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local

  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  - name: response-ratelimiting
    config:
      limits:
        default:
          minute: 500