# Gateway: Traefik + Oathkeeper + Ingress
---
# ============================================
# TRAEFIK CONFIG
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-config
  namespace: marketplace
data:
  traefik.yaml: |
    api:
      dashboard: true
      insecure: true
    ping:
      entryPoint: traefik
    metrics:
      prometheus:
        addEntryPointsLabels: true
        addRoutersLabels: true
    log:
      level: DEBUG
      format: json
    accessLog:
      format: json
    entryPoints:
      web:
        address: ":80"
      traefik:
        address: ":8080"
    providers:
      file:
        filename: /etc/traefik/dynamic.yaml
        watch: true

  dynamic.yaml: |
    http:
      middlewares:
        oidc-auth:
          forwardAuth:
            address: "http://oathkeeper:4456/decisions"
            authResponseHeaders:
              - "Authorization"
            trustForwardHeader: true
        cors-headers:
          headers:
            accessControlAllowMethods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
            accessControlAllowHeaders: ["Accept", "Content-Type", "Authorization"]
            accessControlAllowCredentials: true
            accessControlMaxAge: 3600
            accessControlAllowOriginList:
              - "http://localhost:3000"
        security-headers:
          headers:
            customResponseHeaders:
              X-Content-Type-Options: "nosniff"
              X-Frame-Options: "DENY"
        rate-limit:
          rateLimit:
            average: 100
            burst: 50
        api-chain:
          chain:
            middlewares: [cors-headers, security-headers, rate-limit, oidc-auth]
        public-chain:
          chain:
            middlewares: [cors-headers, security-headers, rate-limit]
      routers:
        root:
          rule: "Path(`/`)"
          entryPoints: [web]
          middlewares: [public-chain]
          service: ping@internal
        article-api-public:
          rule: "PathPrefix(`/api/articles`) && Method(`GET`)"
          entryPoints: [web]
          middlewares: [public-chain]
          service: article-service
        article-api-protected:
          rule: "PathPrefix(`/api/articles`) && !Method(`GET`)"
          entryPoints: [web]
          middlewares: [api-chain]
          service: article-service
        media-api:
          rule: "PathPrefix(`/api/media`)"
          entryPoints: [web]
          middlewares: [api-chain]
          service: article-service
        uploads:
          rule: "PathPrefix(`/uploads`)"
          entryPoints: [web]
          middlewares: [public-chain]
          service: article-service
      services:
        article-service:
          loadBalancer:
            servers:
              - url: "http://article-service:8000"
---
# ============================================
# OATHKEEPER CONFIG
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: oathkeeper-config
  namespace: marketplace
data:
  config.yaml: |
    serve:
      proxy:
        port: 4455
      api:
        port: 4456
    log:
      level: debug
      format: json
    errors:
      fallback: [json]
      handlers:
        json:
          enabled: true
          config:
            verbose: true
    access_rules:
      repositories:
        - file:///etc/oathkeeper/rules.yaml
    authenticators:
      oauth2_introspection:
        enabled: true
        config:
          introspection_url: http://keycloak:8080/realms/collector_realms/protocol/openid-connect/token/introspect
          scope_strategy: none
          introspection_request_headers:
            content-type: application/x-www-form-urlencoded
            authorization: Basic Y29sbGVjdG9yOklESDExc05lS0lGcERVRWNMYXZUelIwUXpZdUpwZjFH
          token_from:
            header: Authorization
      anonymous:
        enabled: true
        config:
          subject: anonymous
      noop:
        enabled: true
    authorizers:
      allow:
        enabled: true
    mutators:
      header:
        enabled: true
        config:
          headers:
            Authorization: "{{ .MatchContext.Header.Get \"Authorization\" }}"
      noop:
        enabled: true

  rules.yaml: |
    - id: article-service-protected
      match:
        url: <http|https>://<.*>/api/articles<.*>
        methods: [POST, PUT, PATCH, DELETE, OPTIONS]
      authenticators:
        - handler: oauth2_introspection
      authorizer:
        handler: allow
      mutators:
        - handler: header
    - id: media-service-protected
      match:
        url: <http|https>://<.*>/api/media<.*>
        methods: [POST, OPTIONS]
      authenticators:
        - handler: oauth2_introspection
      authorizer:
        handler: allow
      mutators:
        - handler: header
---
# ============================================
# TRAEFIK
# ============================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik
  namespace: marketplace
---
apiVersion: v1
kind: Service
metadata:
  name: traefik
  namespace: marketplace
spec:
  ports:
    - name: web
      port: 80
    - name: dashboard
      port: 8080
  selector:
    app: traefik
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik
  namespace: marketplace
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traefik
  template:
    metadata:
      labels:
        app: traefik
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      serviceAccountName: traefik
      initContainers:
        - name: wait-for-keycloak
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c", "until curl -sf http://keycloak:8080/health/ready; do sleep 5; done"]
        - name: wait-for-oathkeeper
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c", "until curl -sf http://oathkeeper:4456/health/alive; do sleep 5; done"]
      containers:
        - name: traefik
          image: traefik:v3.2
          ports:
            - containerPort: 80
            - containerPort: 8080
          args: ["--configFile=/etc/traefik/traefik.yaml"]
          volumeMounts:
            - name: traefik-config
              mountPath: /etc/traefik
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
          readinessProbe:
            httpGet:
              path: /ping
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: traefik-config
          configMap:
            name: traefik-config
---
# ============================================
# OATHKEEPER
# ============================================
apiVersion: v1
kind: Service
metadata:
  name: oathkeeper
  namespace: marketplace
spec:
  ports:
    - name: proxy
      port: 4455
    - name: api
      port: 4456
  selector:
    app: oathkeeper
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oathkeeper
  namespace: marketplace
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oathkeeper
  template:
    metadata:
      labels:
        app: oathkeeper
    spec:
      initContainers:
        - name: wait-for-keycloak
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c", "until curl -sf http://keycloak:8080/health/ready; do sleep 5; done"]
      containers:
        - name: oathkeeper
          image: oryd/oathkeeper:v0.40
          args: ["serve", "--config", "/etc/oathkeeper/config.yaml"]
          ports:
            - containerPort: 4455
            - containerPort: 4456
          env:
            - name: KC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secrets
                  key: client-secret
          volumeMounts:
            - name: oathkeeper-config
              mountPath: /etc/oathkeeper
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          readinessProbe:
            httpGet:
              path: /health/alive
              port: 4456
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: oathkeeper-config
          configMap:
            name: oathkeeper-config
---
# ============================================
# INGRESS (pour acc√®s via hostname)
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: marketplace-ingress
  namespace: marketplace
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: marketplace.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 3000
    - host: api.marketplace.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: traefik
                port:
                  number: 80
    - host: auth.marketplace.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: keycloak
                port:
                  number: 8080
