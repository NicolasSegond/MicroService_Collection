apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-config
  namespace: marketplace
data:
  traefik.yaml: |
    api:
      dashboard: true
      insecure: true

    ping:
      entryPoint: traefik

    metrics:
      prometheus:
        addEntryPointsLabels: true
        addRoutersLabels: true

    log:
      level: DEBUG
      format: json

    accessLog:
      format: json

    entryPoints:
      web:
        address: ":80"
      traefik:
        address: ":8080"

    providers:
      file:
        filename: /etc/traefik/dynamic.yaml
        watch: true

  dynamic.yaml: |
    http:
      middlewares:
        oidc-auth:
          forwardAuth:
            address: "http://oathkeeper:4456/decisions"
            authResponseHeaders:
              - "X-User-Id"
              - "X-User-Email"
              - "X-User-Username"
              - "X-User-Given-Name"
              - "X-User-Family-Name"
              - "X-User-Realm-Access"
              - "Authorization"
            trustForwardHeader: true

        cors-headers:
          headers:
            accessControlAllowMethods:
              - "GET"
              - "POST"
              - "PUT"
              - "PATCH"
              - "DELETE"
              - "OPTIONS"
            accessControlAllowHeaders:
              - "Accept"
              - "Content-Type"
              - "Authorization"
            accessControlExposeHeaders:
              - "X-Request-ID"
            accessControlAllowCredentials: true
            accessControlMaxAge: 3600
            accessControlAllowOriginList:
              - "http://localhost:3000"
              - "http://frontend.marketplace.svc.cluster.local:3000"

        security-headers:
          headers:
            customResponseHeaders:
              X-Content-Type-Options: "nosniff"
              X-Frame-Options: "DENY"
              X-XSS-Protection: "1; mode=block"
              Content-Security-Policy: "default-src 'self'; frame-ancestors 'none'"
              Permissions-Policy: "geolocation=(), microphone=(), camera=()"
              Cache-Control: "no-store, no-cache, must-revalidate"
              Pragma: "no-cache"
            customRequestHeaders:
              Server: ""

        rate-limit:
          rateLimit:
            average: 100
            burst: 50
            period: 1m

        request-size:
          buffering:
            maxRequestBodyBytes: 10485760

        api-chain:
          chain:
            middlewares:
              - cors-headers
              - security-headers
              - rate-limit
              - request-size
              - oidc-auth

        public-chain:
          chain:
            middlewares:
              - cors-headers
              - security-headers
              - rate-limit

      routers:
        root:
          rule: "Path(`/`)"
          entryPoints:
            - web
          middlewares:
            - public-chain
          service: ping@internal

        article-api-public:
          rule: "PathPrefix(`/api/articles`) && Method(`GET`)"
          entryPoints:
            - web
          middlewares:
            - public-chain
          service: article-service

        article-api-protected:
          rule: "PathPrefix(`/api/articles`) && !Method(`GET`)"
          entryPoints:
            - web
          middlewares:
            - api-chain
          service: article-service

        media-api:
          rule: "PathPrefix(`/api/media`)"
          entryPoints:
            - web
          middlewares:
            - api-chain
          service: article-service

        uploads:
          rule: "PathPrefix(`/uploads`)"
          entryPoints:
            - web
          middlewares:
            - public-chain
          service: article-service

        health:
          rule: "Path(`/health`)"
          entryPoints:
            - web
          middlewares:
            - public-chain
          service: ping@internal

      services:
        article-service:
          loadBalancer:
            servers:
              - url: "http://article-service:8000"
